name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
    inputs:
      truenas_version:
        description: "TrueNAS Scale version"
        default: "25.10.1"
        type: string

env:
  TRUENAS_VERSION: ${{ inputs.truenas_version || '25.10.1' }}

jobs:
  integration:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 qemu-utils zstd socat
          sudo chmod 666 /dev/kvm

      - name: Restore cached VM image
        id: cache-vm
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/truenas-vm
          key: truenas-vm-${{ env.TRUENAS_VERSION }}-${{ hashFiles('cmd/setup-truenas/**', 'scripts/truenas-vm.sh', 'scripts/testacc.sh') }}

      - name: Restore TrueNAS ISO cache
        if: steps.cache-vm.outputs.cache-hit != 'true'
        id: cache-iso
        uses: actions/cache/restore@v4
        with:
          path: /tmp/truenas.iso
          key: truenas-iso-${{ env.TRUENAS_VERSION }}

      - name: Download TrueNAS ISO
        if: steps.cache-vm.outputs.cache-hit != 'true' && steps.cache-iso.outputs.cache-hit != 'true'
        run: |
          curl -L -o /tmp/truenas.iso \
            "https://download.truenas.com/TrueNAS-SCALE-Goldeye/${TRUENAS_VERSION}/TrueNAS-SCALE-${TRUENAS_VERSION}.iso"

      - name: Save TrueNAS ISO cache
        if: steps.cache-vm.outputs.cache-hit != 'true' && steps.cache-iso.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /tmp/truenas.iso
          key: truenas-iso-${{ env.TRUENAS_VERSION }}

      - name: Run acceptance tests
        timeout-minutes: 35
        run: |
          if [ "${{ steps.cache-vm.outputs.cache-hit }}" = "true" ]; then
            scripts/testacc.sh --version="${TRUENAS_VERSION}"
          else
            TRUENAS_ISO=/tmp/truenas.iso scripts/testacc.sh --version="${TRUENAS_VERSION}" --vm=reinstall
          fi

      - name: Save VM cache
        if: steps.cache-vm.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/truenas-vm
          key: truenas-vm-${{ env.TRUENAS_VERSION }}-${{ hashFiles('cmd/setup-truenas/**', 'scripts/truenas-vm.sh', 'scripts/testacc.sh') }}

      - name: Dump serial log
        if: always()
        run: tail -100 /tmp/truenas-vm/serial.log || true
